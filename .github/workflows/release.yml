name: Release and Publish

on:
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write
  pull-requests: read

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Determine version bump type
        id: bump_type
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Get the most recent merged PR
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 10
            });
            
            // Find the most recently merged PR
            const mergedPR = prs.find(pr => 
              pr.merged_at && 
              new Date(pr.merged_at) > new Date(Date.now() - 60000) // Within last minute
            );
            
            let bumpType = 'patch'; // default
            
            if (mergedPR) {
              console.log(`Found merged PR #${mergedPR.number}: ${mergedPR.title}`);
              
              const labels = mergedPR.labels.map(l => l.name);
              console.log(`PR labels: ${labels.join(', ')}`);
              
              if (labels.includes('major')) {
                bumpType = 'major';
              } else if (labels.includes('minor')) {
                bumpType = 'minor';
              } else if (labels.includes('patch')) {
                bumpType = 'patch';
              }
            } else {
              console.log('No recently merged PR found, using default: patch');
            }
            
            console.log(`Version bump type: ${bumpType}`);
            return bumpType;
          result-encoding: string

      - name: Bump version
        id: version
        run: |
          echo "Bumping version with type: ${{ steps.bump_type.outputs.result }}"
          node scripts/version-sync.js ${{ steps.bump_type.outputs.result }}
          
          # Read the new version from package.json
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "New version: ${NEW_VERSION}"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit version bump
        run: |
          git add package.json web/package.json src/__init__.py
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }}"
          git push

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push API image
        id: build-api
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.api
          push: true
          platforms: linux/amd64,linux/arm/v7,linux/arm64
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/vesta-api:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository_owner }}/vesta-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push UI image
        id: build-ui
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.ui
          push: true
          platforms: linux/amd64,linux/arm/v7,linux/arm64
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/vesta-ui:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository_owner }}/vesta-ui:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create GitHub Release
        id: create-release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ steps.version.outputs.version }}';
            const tagName = `v${version}`;
            
            // Create a tag
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tagName}`,
                sha: context.sha
              });
              console.log(`Created tag: ${tagName}`);
            } catch (error) {
              console.log(`Tag ${tagName} may already exist: ${error.message}`);
            }
            
            // Get commits since last release
            let releaseNotes = `## What's Changed\n\n`;
            
            try {
              const { data: releases } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 1
              });
              
              if (releases.length > 0) {
                const lastRelease = releases[0];
                const { data: comparison } = await github.rest.repos.compareCommits({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  base: lastRelease.tag_name,
                  head: context.sha
                });
                
                releaseNotes += comparison.commits
                  .map(commit => `- ${commit.commit.message.split('\n')[0]} (${commit.sha.substring(0, 7)})`)
                  .join('\n');
              } else {
                releaseNotes += 'Initial release';
              }
            } catch (error) {
              console.log('Could not generate comparison, using default notes');
              releaseNotes += 'See commit history for changes.';
            }
            
            releaseNotes += `\n\n## üê≥ Docker Images\n\n`;
            releaseNotes += `Multi-architecture images available for:\n`;
            releaseNotes += `- **linux/amd64** - Synology NAS, x86-64 systems\n`;
            releaseNotes += `- **linux/arm/v7** - Raspberry Pi 3B+, Zero 2W (32-bit)\n`;
            releaseNotes += `- **linux/arm64** - Raspberry Pi 4, Pi 5 (64-bit)\n\n`;
            releaseNotes += `### Pull Commands\n\n`;
            releaseNotes += `\`\`\`bash\n`;
            releaseNotes += `docker pull ghcr.io/${{ github.repository_owner }}/vesta-api:${version}\n`;
            releaseNotes += `docker pull ghcr.io/${{ github.repository_owner }}/vesta-ui:${version}\n`;
            releaseNotes += `\`\`\`\n\n`;
            releaseNotes += `### Use in docker-compose.yml\n\n`;
            releaseNotes += `\`\`\`yaml\n`;
            releaseNotes += `services:\n`;
            releaseNotes += `  vestaboard-api:\n`;
            releaseNotes += `    image: ghcr.io/${{ github.repository_owner }}/vesta-api:${version}\n`;
            releaseNotes += `  vestaboard-ui:\n`;
            releaseNotes += `    image: ghcr.io/${{ github.repository_owner }}/vesta-ui:${version}\n`;
            releaseNotes += `\`\`\`\n\n`;
            releaseNotes += `### Container Registry Links\n\n`;
            releaseNotes += `- [vesta-api packages](https://github.com/${{ github.repository_owner }}/vesta/pkgs/container/vesta-api)\n`;
            releaseNotes += `- [vesta-ui packages](https://github.com/${{ github.repository_owner }}/vesta/pkgs/container/vesta-ui)\n`;
            releaseNotes += `\n## üçì Raspberry Pi Images\n\n`;
            releaseNotes += `Pre-configured bootable images for Raspberry Pi. Flash to SD card and boot!\n\n`;
            releaseNotes += `**Downloads:**\n`;
            releaseNotes += `- \`vesta-pi-arm32-v${version}.img.gz\` - For Raspberry Pi 3B+, Zero 2W\n`;
            releaseNotes += `- \`vesta-pi-arm64-v${version}.img.gz\` - For Raspberry Pi 4, Pi 5\n\n`;
            releaseNotes += `**Quick Start:**\n`;
            releaseNotes += `1. Download the appropriate image for your Pi model\n`;
            releaseNotes += `2. Flash to SD card using [Raspberry Pi Imager](https://www.raspberrypi.com/software/) or [Balena Etcher](https://etcher.balena.io/)\n`;
            releaseNotes += `3. Insert SD card and boot your Pi\n`;
            releaseNotes += `4. Access web UI at http://raspberrypi.local:4420\n`;
            releaseNotes += `5. Follow the first-boot setup wizard\n\n`;
            releaseNotes += `See [Raspberry Pi Quick Start Guide](docs/deployment/RASPBERRY_PI_QUICK_START.md) for detailed instructions.\n`;
            
            // Create the release
            const { data: release } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tagName,
              name: `Release ${version}`,
              body: releaseNotes,
              draft: false,
              prerelease: false
            });
            
            console.log(`Created release: ${release.html_url}`);
      
      - name: Revert on build failure
        if: failure() && (steps.build-api.outcome == 'failure' || steps.build-ui.outcome == 'failure')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('üö® Docker build failed! Reverting merge...');
            
            // Get the commit that triggered this workflow
            const { data: commit } = await github.rest.repos.getCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha
            });
            
            // Check if this is a merge commit
            let prNumber = null;
            let revertMessage = `Revert: ${commit.commit.message.split('\n')[0]}`;
            
            // Try to extract PR number from merge commit message
            const prMatch = commit.commit.message.match(/Merge pull request #(\d+)/);
            if (prMatch) {
              prNumber = parseInt(prMatch[1]);
              revertMessage = `Revert merge of PR #${prNumber} - Docker build failed`;
            }
            
            // Create revert commit
            try {
              // Get the parent commit (the one before the merge)
              const parentSha = commit.parents[0].sha;
              
              // Update the main branch to point to the parent
              await github.rest.git.updateRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: 'heads/main',
                sha: parentSha,
                force: true
              });
              
              console.log(`‚úÖ Successfully reverted main to ${parentSha}`);
              
              // If we found a PR, comment on it
              if (prNumber) {
                try {
                  // Get PR details
                  const { data: pr } = await github.rest.pulls.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_request_number: prNumber
                  });
                  
                  // Re-open the PR if it was closed
                  if (pr.state === 'closed') {
                    await github.rest.pulls.update({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      pull_request_number: prNumber,
                      state: 'open'
                    });
                    console.log(`‚úÖ Re-opened PR #${prNumber}`);
                  }
                  
                  // Add comment to PR
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: prNumber,
                    body: `## üö® Docker Build Failed\n\nThe merge to \`main\` has been automatically reverted because the Docker build failed.\n\n**Build logs:** ${context.payload.repository.html_url}/actions/runs/${context.runId}\n\nPlease fix the Docker build issues and re-submit this PR.`
                  });
                  
                  console.log(`‚úÖ Posted comment to PR #${prNumber}`);
                } catch (error) {
                  console.log(`‚ö†Ô∏è  Could not update PR #${prNumber}: ${error.message}`);
                }
              } else {
                // Create an issue if we can't find the PR
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'üö® Docker Build Failed - Merge Reverted',
                  body: `The merge to \`main\` at commit ${context.sha} has been automatically reverted because the Docker build failed.\n\n**Build logs:** ${context.payload.repository.html_url}/actions/runs/${context.runId}\n\nPlease investigate and fix the Docker build issues.`,
                  labels: ['bug', 'build-failure']
                });
                console.log('‚úÖ Created issue for build failure');
              }
            } catch (error) {
              console.error(`‚ùå Failed to revert: ${error.message}`);
              core.setFailed(`Failed to revert merge: ${error.message}`);
            }

  build-pi-images:
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip parted kpartx qemu-user-static

      - name: Build ARM32 Pi image
        run: |
          chmod +x scripts/build-pi-image.sh
          ./scripts/build-pi-image.sh arm32 ${{ needs.release.outputs.version }}

      - name: Build ARM64 Pi image
        run: |
          chmod +x scripts/build-pi-image.sh
          ./scripts/build-pi-image.sh arm64 ${{ needs.release.outputs.version }}

      - name: Upload Pi images to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.release.outputs.version }}
          files: |
            vesta-pi-arm32-v${{ needs.release.outputs.version }}.img.gz
            vesta-pi-arm64-v${{ needs.release.outputs.version }}.img.gz

