name: Release and Publish

on:
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write
  pull-requests: read

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Determine version bump type
        id: bump_type
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Get the most recent merged PR
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 10
            });
            
            // Find the most recently merged PR
            const mergedPR = prs.find(pr => 
              pr.merged_at && 
              new Date(pr.merged_at) > new Date(Date.now() - 60000) // Within last minute
            );
            
            let bumpType = 'patch'; // default
            
            if (mergedPR) {
              console.log(`Found merged PR #${mergedPR.number}: ${mergedPR.title}`);
              
              const labels = mergedPR.labels.map(l => l.name);
              console.log(`PR labels: ${labels.join(', ')}`);
              
              if (labels.includes('major')) {
                bumpType = 'major';
              } else if (labels.includes('minor')) {
                bumpType = 'minor';
              } else if (labels.includes('patch')) {
                bumpType = 'patch';
              }
            } else {
              console.log('No recently merged PR found, using default: patch');
            }
            
            console.log(`Version bump type: ${bumpType}`);
            return bumpType;
          result-encoding: string

      - name: Bump version
        id: version
        run: |
          echo "Bumping version with type: ${{ steps.bump_type.outputs.result }}"
          node scripts/version-sync.js ${{ steps.bump_type.outputs.result }}
          
          # Read the new version from package.json
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "New version: ${NEW_VERSION}"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit version bump
        run: |
          git add package.json web/package.json src/__init__.py
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }}"
          git push

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.api
          push: true
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/vesta-api:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository_owner }}/vesta-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push UI image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.ui
          push: true
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/vesta-ui:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository_owner }}/vesta-ui:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ steps.version.outputs.version }}';
            const tagName = `v${version}`;
            
            // Create a tag
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tagName}`,
                sha: context.sha
              });
              console.log(`Created tag: ${tagName}`);
            } catch (error) {
              console.log(`Tag ${tagName} may already exist: ${error.message}`);
            }
            
            // Get commits since last release
            let releaseNotes = `## What's Changed\n\n`;
            
            try {
              const { data: releases } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 1
              });
              
              if (releases.length > 0) {
                const lastRelease = releases[0];
                const { data: comparison } = await github.rest.repos.compareCommits({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  base: lastRelease.tag_name,
                  head: context.sha
                });
                
                releaseNotes += comparison.commits
                  .map(commit => `- ${commit.commit.message.split('\n')[0]} (${commit.sha.substring(0, 7)})`)
                  .join('\n');
              } else {
                releaseNotes += 'Initial release';
              }
            } catch (error) {
              console.log('Could not generate comparison, using default notes');
              releaseNotes += 'See commit history for changes.';
            }
            
            releaseNotes += `\n\n## Docker Images\n\n`;
            releaseNotes += `- \`ghcr.io/${{ github.repository_owner }}/vesta-api:${version}\`\n`;
            releaseNotes += `- \`ghcr.io/${{ github.repository_owner }}/vesta-ui:${version}\`\n`;
            
            // Create the release
            const { data: release } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tagName,
              name: `Release ${version}`,
              body: releaseNotes,
              draft: false,
              prerelease: false
            });
            
            console.log(`Created release: ${release.html_url}`);

