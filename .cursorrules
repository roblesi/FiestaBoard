# Vesta Project Development Rules

## Docker-First Development

This project uses Docker containers for ALL development, testing, and debugging activities.

### Core Rules

1. **NEVER run the API server (`src/api_server.py` or `python -m src.api_server`) directly on the host machine**
   - Always use Docker containers via `docker-compose` commands

2. **NEVER run the web UI (`npm run dev` in `web/` directory) directly on the host machine**
   - Always use Docker containers via `docker-compose` commands

3. **NEVER install Python dependencies locally or suggest running `pip install`**
   - All Python dependencies are managed within Docker containers

4. **NEVER install Node.js dependencies locally or suggest running `npm install` in the web/ directory**
   - All Node.js dependencies are managed within Docker containers

### Development Workflow

- **Starting services**: Use `/start` command or `docker-compose -f docker-compose.dev.yml up`
- **Stopping services**: Use `/stop` command or `docker-compose -f docker-compose.dev.yml down`
- **Restarting**: Use `/restart` command (stops, rebuilds with --no-cache, restarts)
- **Building**: Use `/build` command to rebuild images without restarting
- **Running tests**: Use `/test-api` or `/test-web` commands to run tests inside Docker containers
- **Debugging**: Use `docker-compose logs -f` or `docker-compose exec` for interactive debugging
- **Checking status**: Use `docker-compose ps` to see which containers are running
- **Code changes**: Edit code on host machine; Docker volumes will sync changes automatically
- **Installing dependencies**: 
  - For Python: Update `requirements.txt` and rebuild containers
  - For Node.js: Update `web/package.json` and rebuild containers

### Testing Guidelines

- All tests must run inside Docker containers
- Use `docker-compose exec <service> pytest` for Python tests
- Use `docker-compose exec <service> npm test` for web tests
- Re-testing after changes should also be done in containers

### Exceptions

The only code that may run locally:
- The `macos_helper/` service (macOS-specific Apple Music integration)
- Utility scripts explicitly marked for local execution

### Available Cursor Commands

- `/setup` - Check and install prerequisites (Homebrew, Docker) and configure environment
- `/start` - Start all Docker containers
- `/stop` - Stop all Docker containers
- `/restart` - Stop, rebuild with --no-cache, and restart all containers
- `/redeploy` - Full rebuild with --no-cache and restart (alias for restart)
- `/redeploy-quick` - Quick rebuild (with cache) and restart
- `/build` - Rebuild Docker images without restarting
- `/status` - Show status of all Docker containers
- `/logs` - View Docker container logs
- `/test-api` - Run API tests in Docker
- `/test-web` - Run web tests in Docker
- `/deploy-to-nas` - Deploy to Synology NAS (builds images, transfers to NAS, starts containers)

### When Suggesting Commands

Always suggest Docker-based commands:
- ✅ Use `/start` and `/stop` Cursor commands to control containers
- ✅ Use `/restart` Cursor command for full redeployment with clean rebuild
- ✅ Use `/build` Cursor command to rebuild images
- ✅ Use `/test-api` or `/test-web` Cursor commands for testing
- ✅ `docker-compose -f docker-compose.dev.yml up`
- ✅ `docker-compose exec api pytest`
- ✅ `docker-compose exec web npm test`
- ❌ `python src/api_server.py`
- ❌ `cd web && npm run dev`
- ❌ `pip install -r requirements.txt`

## Plugin Architecture

This project uses a **plugin-based architecture** for data source integrations. Each plugin is self-contained with its own code, configuration, tests, and documentation.

### Plugin vs Platform Code

- **Plugins** (`plugins/`): Self-contained data source integrations (weather, transit, stocks, etc.)
- **Platform** (`src/`): Core FiestaBoard infrastructure (API server, template engine, board client)

### Key Plugin Concepts

- Plugins live in `plugins/<plugin_id>/` directories
- Each plugin has a `manifest.json` defining metadata, settings schema, and variables
- Plugins implement the `PluginBase` class from `src/plugins/base.py`
- Plugin IDs must be unique and match the directory name
- All plugins require tests with >80% coverage

## Documentation Requirements

### Plugin Documentation

When creating or modifying a plugin:
- **DO NOT update the main README.md** for individual plugins
- Plugin documentation goes in the plugin's own directory:
  - `plugins/PLUGIN_NAME/README.md` - Developer documentation (how plugin works)
  - `plugins/PLUGIN_NAME/docs/SETUP.md` - User-facing setup guide (API keys, etc.)
  - `plugins/PLUGIN_NAME/manifest.json` - Configuration schema and env vars

### User-Facing Setup Guides

For user-facing setup instructions (API key registration, configuration):
- Create `plugins/PLUGIN_NAME/docs/SETUP.md` inside the plugin directory
- Include screenshots in the plugin's `docs/` directory
- Use relative path format: `![Description](./screenshot.png)`

### Platform Documentation

When modifying platform/core functionality:
- Update `README.md` for significant platform changes
- Update `docs/development/PLUGIN_DEVELOPMENT.md` for plugin system changes
- Document new platform features in appropriate `docs/` subdirectory

### Environment Variables

- **For plugins**: Document in `manifest.json` under `env_vars` array
- **For platform**: Document in `env.example` with clear descriptions

## Development Artifacts

### No Temporary Markdown Files

**NEVER leave temporary markdown files in the repository root after completing a feature or task.**

Examples of files that should NOT be committed or left behind:
- ❌ Implementation notes (e.g., `FEATURE_IMPLEMENTATION.md`, `BAYWHEELS_UI_UPDATE.md`)
- ❌ Testing notes (e.g., `MANUAL_TESTING_*.md`, `TESTING_*.md`)
- ❌ Review summaries (e.g., `REVIEW_SUMMARY.md`, `IMPLEMENTATION_SUMMARY.md`)
- ❌ Edge case documentation (e.g., `EDGE_CASES.md`, `STATE_TRACKING.md`)
- ❌ Performance test notes (e.g., `PERFORMANCE_TEST.md`)
- ❌ Fix documentation (e.g., `DOCKER_PUBLISHING_FIX.md`)

### Proper Documentation Locations

Instead, put documentation in the appropriate place:

**For permanent documentation:**
- **Plugin developer docs**: `plugins/PLUGIN_NAME/README.md` - How the plugin works
- **Plugin setup guides**: `plugins/PLUGIN_NAME/docs/SETUP.md` - User-facing setup instructions
- **Plugin development**: `docs/development/PLUGIN_DEVELOPMENT.md` - How to create plugins
- **Deployment**: `docs/deployment/*.md` - Deployment and infrastructure docs
- **Reference**: `docs/reference/*.md` - Technical reference material
- **Setup**: `docs/setup/*.md` - Development environment setup
- **Architecture**: Add to `README.md` or create `docs/reference/ARCHITECTURE.md`
- **Web UI features**: `web/src/components/README.md` or component-specific docs in `web/`

**For temporary notes during development:**
- Keep notes in your local environment (not in git)
- Use comments in code for implementation details
- Use PR descriptions for change summaries
- Delete any temporary `.md` files before committing

### Cleanup Rule

Before completing any feature or task:
1. Review the repository root for any `*.md` files that aren't `README.md`
2. Move any valuable information to the proper location in `docs/`
3. Delete all temporary implementation/testing markdown files
4. Ensure all critical information is preserved in proper documentation

## Plugin Development Rules

### Creating a New Plugin

When creating a new plugin:
1. Copy the template: `cp -r plugins/_template plugins/my_plugin`
2. Update `manifest.json` with unique ID matching directory name
3. Implement `PluginBase` class in `__init__.py`
4. Create tests in `tests/` directory with >80% coverage
5. Write user-facing setup guide in `docs/SETUP.md`

### Required Plugin Files

Every plugin MUST have:
- `__init__.py` - Plugin implementation (PluginBase subclass)
- `manifest.json` - Plugin metadata, settings schema, variables
- `README.md` - Plugin documentation (developer-focused)
- `tests/` - Test directory with test files
- `docs/SETUP.md` - User-facing setup guide

### Plugin Manifest Requirements

The `manifest.json` MUST include:
- `id` - Unique identifier matching directory name (lowercase, underscores)
- `name` - Human-readable display name
- `version` - Semantic version (X.Y.Z)
- `settings_schema` - JSON Schema for configuration
- `variables` - Template variables exposed by plugin

Optional but recommended:
- `icon` - Lucide icon name for UI display
- `category` - Category for grouping (weather, transit, home, etc.)
- `description` - Brief description
- `author` - Plugin author/maintainer

### Plugin Testing Requirements

- All plugins MUST have tests in `tests/` directory
- Minimum coverage requirement: **80%**
- CI will fail if coverage is below threshold
- Run tests with: `python scripts/run_plugin_tests.py --plugin=my_plugin`

### Plugin Validation

CI automatically validates:
- All plugin IDs are unique (no duplicates allowed)
- Plugin ID matches directory name
- Manifest has required fields
- Manifest JSON is valid

### When Modifying Plugins

- ✅ Edit plugin files in `plugins/PLUGIN_NAME/`
- ✅ Update plugin's own `README.md`
- ✅ Update plugin's `manifest.json` for config changes
- ✅ Add/update tests in plugin's `tests/` directory
- ❌ Do NOT add plugin-specific code to `src/` (platform code)
- ❌ Do NOT document individual plugins in main `README.md`

